### Обзор Microsoft SQL Server (MSSQL)

**Что такое MSSQL?**
- **Microsoft SQL Server (MSSQL)** — это система управления реляционными базами данных, разработанная компанией Microsoft. Она использует SQL (Structured Query Language) для управления данными.
- В отличие от MySQL, MSSQL — это проприетарное программное обеспечение. Первоначально оно было разработано для работы на операционных системах Windows, хотя теперь существуют версии для Linux и MacOS.
- MSSQL популярен среди разработчиков и администраторов баз данных, особенно в экосистеме .NET, благодаря своей встроенной поддержке .NET Framework.

### **Клиенты MSSQL**

- **SQL Server Management Studio (SSMS)** — основное средство управления MSSQL, которое может быть установлено вместе с пакетом MSSQL или загружено отдельно. Обычно используется для первоначальной настройки и длительного управления базами данных. SSMS можно установить на любой системе для управления базой данных, а не только на сервере, где она развернута.
  
- Другие клиенты MSSQL включают:
  - **mssql-cli**
  - **SQL Server PowerShell**
  - **HeidiSQL**
  - **SQLPro**
  - **Impacket's mssqlclient.py**

  Для пентестеров полезным может быть **Impacket's mssqlclient.py**, так как он часто включен в дистрибутивы для пентестинга. Чтобы найти его на хосте, можно использовать команду:
  ```bash
  locate mssqlclient
  ```

### **Базы данных MSSQL**

MSSQL включает несколько системных баз данных, которые помогают понять структуру всех баз данных на сервере:

- **master** — отслеживает всю системную информацию для экземпляра SQL Server.
- **model** — шаблонная база данных, которая используется как структура для создания новых баз данных.
- **msdb** — используется SQL Server Agent для планирования задач и оповещений.
- **tempdb** — хранит временные объекты.
- **resource** — только для чтения база данных, содержащая системные объекты SQL Server.

### **Конфигурация по умолчанию**

При первоначальной установке MSSQL и его настройке для сетевого доступа, служба SQL обычно работает под именем **NT SERVICE\MSSQLSERVER**. Подключение с клиентской стороны возможно через **Windows Authentication**, и по умолчанию шифрование не обязательно при подключении.

- **Windows Authentication** — это метод аутентификации, при котором входные запросы обрабатываются Windows OS, используя локальную SAM базу данных или контроллер домена. Это может быть удобно для аудита активности и управления доступом в среде Windows, но компрометация учетной записи может привести к повышению привилегий и перемещению по домену Windows.

### **Опасные настройки**

- **Отсутствие шифрования**: Если клиенты MSSQL не используют шифрование для подключения к серверу.
- **Самоподписанные сертификаты**: При использовании шифрования, самоподписанные сертификаты могут быть подделаны.
- **Именованные каналы (Named Pipes)**: Использование именованных каналов может представлять риск.
- **Слабые или стандартные учетные данные sa**: Администраторы могут забыть отключить эту учетную запись, что представляет риск безопасности.

### **Анализ сервиса**

Для сборки информации о сервисе MSSQL можно использовать различные инструменты:

#### **Nmap**

С помощью Nmap можно провести сканирование MSSQL сервиса и получить полезную информацию, такую как имя хоста, имя экземпляра базы данных, версия ПО и активные именованные каналы:
```bash
sudo nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <IP-адрес>
```

#### **Metasploit**

Metasploit также предоставляет модули для сканирования MSSQL:
```bash
msf6 auxiliary(scanner/mssql/mssql_ping) > set rhosts <IP-адрес>
msf6 auxiliary(scanner/mssql/mssql_ping) > run
```

### **Подключение с помощью mssqlclient.py**

Если удастся получить или угадать учетные данные, можно подключиться к серверу MSSQL и начать взаимодействие с базами данных через T-SQL. Для этого используйте **Impacket's mssqlclient.py**:
```bash
python3 mssqlclient.py <пользователь>@<IP-адрес> -windows-auth
```

После подключения можно просмотреть базы данных на сервере:
```sql
select name from sys.databases
```
