### Краткая выжимка по SMTP

**SMTP (Simple Mail Transfer Protocol)** — протокол для отправки электронной почты в сети IP. Он используется между почтовым клиентом и сервером исходящей почты или между двумя SMTP-серверами.

**Основные порты:**
- **Порт 25 (TCP):** стандартный порт для подключения к SMTP-серверам.
- **Порт 587 (TCP):** используется для защищенных соединений с использованием STARTTLS для шифрования передаваемых данных.

**Процесс работы SMTP:**
1. **Клиент (MUA)** отправляет письмо на **Submission Agent (MSA)**.
2. **MSA** проверяет валидность письма и отправляет его на **Mail Transfer Agent (MTA)**.
3. **MTA** проверяет письмо и отправляет его на другой SMTP-сервер, который снова использует **MTA**.
4. При доставке на конечный SMTP-сервер, данные передаются **Mail Delivery Agent (MDA)** в почтовый ящик получателя.

**Основные команды SMTP:**
- **HELO/EHLO:** начало сессии, представление клиента серверу.
- **MAIL FROM:** указание отправителя.
- **RCPT TO:** указание получателя.
- **DATA:** передача содержимого письма.
- **QUIT:** завершение сессии.

**Проблемы безопасности:**
- **Открытые реле (Open Relay):** серверы, которые неправильно настроены, могут использоваться для массовой рассылки спама.
- **Подделка отправителя (mail spoofing):** злоумышленники могут использовать поддельные адреса отправителей.
- **Отсутствие шифрования:** по умолчанию SMTP передает данные в открытом виде, что делает их уязвимыми.

**Безопасные расширения:**
- **ESMTP (Extended SMTP):** поддерживает шифрование через TLS (использование команды STARTTLS) и аутентификацию через AUTH PLAIN.
- **SPF, DKIM:** методы защиты от подделки отправителя и спама.

**Опасные настройки:**
- **`mynetworks = 0.0.0.0/0`:** позволяет всем IP-адресам отправлять письма через сервер, что делает его уязвимым для атак.

### Инструменты для исследования SMTP:

#### 1. **Telnet**
Используется для ручного взаимодействия с SMTP-сервером:

```bash
telnet <IP-адрес сервера> 25
```

Примеры команд в сессии Telnet:
- **HELO/EHLO**
- **MAIL FROM**
- **RCPT TO**
- **DATA**
- **QUIT**

#### 2. **Nmap**
Для сканирования SMTP-серверов и проверки их конфигурации:

1. **Сканирование доступных команд SMTP:**

```bash
sudo nmap <IP-адрес сервера> -sC -sV -p25
```

Этот скрипт использует команду `EHLO` для получения списка поддерживаемых команд на целевом SMTP-сервере.

2. **Проверка на открытое реле (Open Relay):**

```bash
sudo nmap <IP-адрес сервера> -p25 --script smtp-open-relay -v
```

Этот скрипт проверяет, является ли целевой SMTP-сервер открытым реле, используя 16 различных тестов.

#### 3. **smtp-user-enum**
Команда **smtp-user-enum** используется для перечисления существующих пользователей на SMTP-сервере, что может быть полезно при проведении тестов на проникновение.

**Примеры использования smtp-user-enum:**

1. **Перечисление пользователей с использованием команды VRFY:**

```bash
smtp-user-enum -M VRFY -U users.txt -t <IP-адрес сервера>
```

- **`-M VRFY`**: Использует команду VRFY для проверки наличия пользователей.
- **`-U users.txt`**: Указывает файл с предполагаемыми именами пользователей.
- **`-t <IP-адрес>`**: Целевой SMTP-сервер.

2. **Перечисление пользователей с использованием команды RCPT TO:**

```bash
smtp-user-enum -M RCPT -U users.txt -t <IP-адрес сервера>
```

- **`-M RCPT`**: Использует команду RCPT TO для проверки наличия пользователей.
- **`-U users.txt`**: Указывает файл с предполагаемыми именами пользователей.
- **`-t <IP-адрес>`**: Целевой SMTP-сервер.

Эти команды помогут вам эффективно исследовать SMTP-серверы на предмет их уязвимостей и доступных пользователей.

Иногда может не найти пользователя просто потому, что время на ответ маленькое.